name: Nix CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  nix-flake-check:
    name: Nix flake check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Install Nix â„ï¸
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Nix cache ğŸ—„ï¸
        uses: actions/cache@v3
        with:
          path: /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Check flake â„ï¸
        run: nix flake check

  nix-build:
    name: Nix build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Install Nix â„ï¸
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Nix cache ğŸ—„ï¸
        uses: actions/cache@v3
        with:
          path: /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Build xk6-nats package ğŸ—ï¸
        run: nix build .#k6-pondigo-nats

      - name: Build development shell ğŸš
        run: nix build .#devShells.x86_64-linux.default

  cross-platform-build:
    name: Cross-platform Nix build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        system: [x86_64-linux, aarch64-linux, x86_64-darwin, aarch64-darwin]
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Install Nix â„ï¸
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Nix cache ğŸ—„ï¸
        uses: actions/cache@v3
        with:
          path: /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Build for ${{ matrix.system }} ğŸ—ï¸
        run: nix build .#packages.${{ matrix.system }}.k6-pondigo-nats || echo "Build failed for ${{ matrix.system }} (expected for unsupported platforms)"