name: Update Vendor Hash

on:
  push:
    branches:
      - main
    paths:
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

jobs:
  update-vendor-hash:
    name: Update vendor hash
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix â„ï¸
        uses: cachix/install-nix-action@v22
        with:
          nix_path: nixpkgs=channel:nixos-unstable



      - name: Get current vendor hash ðŸ”
        id: current-hash
        run: |
          current_hash=$(grep 'vendorHash = ' flake.nix | sed 's/.*"\(.*\)".*/\1/')
          echo "current-hash=$current_hash" >> $GITHUB_OUTPUT

      - name: Update vendor hash ðŸ”„
        id: update
        run: |
          if ./scripts/update-vendor-hash.sh; then
            new_hash=$(grep 'vendorHash = ' flake.nix | sed 's/.*"\(.*\)".*/\1/')
            echo "new-hash=$new_hash" >> $GITHUB_OUTPUT
            echo "Hash updated successfully"
          else
            echo "new-hash=" >> $GITHUB_OUTPUT
            echo "No hash update needed"
          fi

      - name: Create Pull Request ðŸ”„
        if: steps.update.outputs.new-hash != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update vendor hash"
          title: "chore: update vendor hash"
          body: |
            Automated vendor hash update triggered by changes to go.mod or go.sum.
            
            - Old hash: `${{ steps.current-hash.outputs.current-hash }}`
            - New hash: `${{ steps.update.outputs.new-hash }}`
            
            This PR was created automatically by the Update Vendor Hash workflow.
          branch: update-vendor-hash
          delete-branch: true